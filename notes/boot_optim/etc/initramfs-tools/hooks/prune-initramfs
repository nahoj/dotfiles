#!/bin/sh
set -e

PREREQ=""
prereqs() { echo "$PREREQ"; }
case $1 in
  prereqs) prereqs; exit 0 ;;
esac

# Remove snap rules
rm -f "${DESTDIR}/usr/lib/udev/rules.d"/70-snap.* 2>/dev/null || true

# Remove other non-essential rules
rm -f "${DESTDIR}/usr/lib/udev/rules.d"/42-logitech-unify-permissions.rules 2>/dev/null || true
rm -f "${DESTDIR}/usr/lib/udev/rules.d"/51-android.rules 2>/dev/null || true
rm -f "${DESTDIR}/usr/lib/udev/rules.d"/99-usb-wakeup-block-logibolt.rules 2>/dev/null || true

# Remove casper scripts (live CD stuff)
rm -rf "${DESTDIR}/scripts/casper-bottom" 2>/dev/null || true
rm -rf "${DESTDIR}/scripts/casper-premount" 2>/dev/null || true


# Write an initramfs-only modprobe blacklist.
# Not redundant with /etc/initramfs-tools/modules as the minimal list still pulls some unnecessary deps.
mkdir -p "${DESTDIR}/etc/modprobe.d"
cat > "${DESTDIR}/etc/modprobe.d/blacklist-initramfs.conf" <<'EOF'
# Only inside initramfs — defer KMS

# Chelsio NICs (not needed for boot)
blacklist cxgb3
blacklist cxgb4
blacklist libcxgb
blacklist cxgb3i
blacklist cxgb4i
blacklist libcxgbi

# iSCSI (not needed unless you boot from iSCSI)
blacklist iscsi_tcp
blacklist libiscsi
blacklist libiscsi_tcp
blacklist scsi_transport_iscsi
blacklist iscsi_ibft

# GPU drivers (load after unlock)
#blacklist i915
blacklist nvidia
blacklist nvidia_drm
blacklist nvidia_modeset
blacklist nvidia_uvm
blacklist xe

# Media/CEC/RC (not needed for cryptsetup)
blacklist cec
blacklist rc-core

# The WMI spam (1.920–1.922s) and MEI (1.959s) serve no purpose before unlock.
blacklist mei_me
blacklist mei_wdt

# Sound (not needed in initramfs)
blacklist snd_hda_intel
blacklist snd_usb_audio
blacklist snd_soc_skl

# Thunderbolt (unless you boot from it)
blacklist thunderbolt

# Misc
blacklist mac_hid
blacklist psmouse
EOF
